---
import HomeIcon from "./icons/HomeIcon.astro";
import BriefcaseIcon from "./icons/BriefcaseIcon.astro";
import CodeIcon from "./icons/CodeIcon.astro";
import FolderIcon from "./icons/FolderIcon.astro";
import SunIcon from "./icons/SunIcon.astro";
import MoonIcon from "./icons/MoonIcon.astro";
---

<nav class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50" id="dock">
  <div
    class="dock-container flex items-end gap-1 px-2 py-2 bg-white/80 dark:bg-[#1a1a2e]/80 backdrop-blur-xl border border-gray-200 dark:border-white/10 rounded-2xl shadow-lg"
  >
    <button
      class="dock-item dock-nav flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer !text-[#16a34a] dark:!text-[#50fa7b] origin-bottom"
      data-window="hero"
      data-key="1"
      aria-label="Home (1)"
    >
      <HomeIcon class="w-4 h-4 sm:hidden" />
      <span class="hidden sm:inline font-mono text-sm">~/</span>
    </button>

    <button
      class="dock-item dock-nav flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer origin-bottom"
      data-window="experience"
      data-key="2"
      aria-label="Experience (2)"
    >
      <BriefcaseIcon class="w-4 h-4 sm:hidden" />
      <span class="hidden sm:inline font-mono text-sm">exp</span>
    </button>

    <button
      class="dock-item dock-nav flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer origin-bottom"
      data-window="skills"
      data-key="3"
      aria-label="Skills (3)"
    >
      <CodeIcon class="w-4 h-4 sm:hidden" />
      <span class="hidden sm:inline font-mono text-sm" id="dockSkillsText"
        >skills</span
      >
    </button>

    <button
      class="dock-item dock-nav flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer origin-bottom"
      data-window="projects"
      data-key="4"
      aria-label="Projects (4)"
    >
      <FolderIcon class="w-4 h-4 sm:hidden" />
      <span class="hidden sm:inline font-mono text-sm" id="dockProjectsText"
        >projects</span
      >
    </button>

    <div
      class="w-px h-4 bg-gray-300 dark:bg-gray-600 mx-0.5 sm:mx-1 self-center"
    >
    </div>

    <button
      class="dock-item flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer origin-bottom"
      id="dockThemeMode"
      aria-label="Toggle theme"
    >
      <span id="dockThemeIconLight" class="sm:hidden">
        <SunIcon class="w-4 h-4" />
      </span>
      <span id="dockThemeIconDark" class="sm:hidden hidden">
        <MoonIcon class="w-4 h-4" />
      </span>
      <span class="hidden sm:inline font-mono text-sm" id="dockThemeModeText"
        >dark</span
      >
    </button>

    <button
      class="dock-item flex items-center justify-center px-2 sm:px-3 py-1.5 rounded-xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 cursor-pointer origin-bottom"
      id="dockLangMode"
      aria-label="Toggle language"
    >
      <span class="font-mono text-sm" id="dockLangModeText">es</span>
    </button>
  </div>
</nav>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dockItems = document.querySelectorAll(".dock-item");
    const dockNavItems = document.querySelectorAll(".dock-nav[data-window]");
    const windows = document.querySelectorAll(
      ".window[data-window]"
    ) as NodeListOf<HTMLElement>;
    const closeButtons = document.querySelectorAll(".window-close");
    const desktopCat = document.getElementById("desktopCat");

    const activeClasses = ["!text-[#16a34a]", "dark:!text-[#50fa7b]"];

    const windowKeys: Record<string, string> = {
      "1": "hero",
      "2": "experience",
      "3": "skills",
      "4": "projects",
    };

    let windowHistory: string[] = ["hero"];
    let currentWindow: string | null = "hero";

    function showCat() {
      if (desktopCat) {
        desktopCat.classList.remove("opacity-0", "scale-90");
        desktopCat.classList.add("opacity-100", "scale-100");
      }
    }

    function hideCat() {
      if (desktopCat) {
        desktopCat.classList.remove("opacity-100", "scale-100");
        desktopCat.classList.add("opacity-0", "scale-90");
      }
    }

    function updateDockActiveState() {
      dockNavItems.forEach((item) => {
        const itemWindow = item.getAttribute("data-window");
        if (itemWindow === currentWindow) {
          activeClasses.forEach((cls) => item.classList.add(cls));
        } else {
          activeClasses.forEach((cls) => item.classList.remove(cls));
        }
      });
    }

    function switchWindow(targetId: string) {
      if (currentWindow === targetId) return;

      hideCat();

      windows.forEach((win) => {
        if (win.id === targetId) {
          win.classList.remove("exit");
          win.classList.add("active");
        } else {
          win.classList.remove("active");
          win.classList.add("exit");
          setTimeout(() => {
            win.classList.remove("exit");
          }, 500);
        }
      });

      if (targetId) {
        const historyIndex = windowHistory.indexOf(targetId);
        if (historyIndex !== -1) {
          windowHistory.splice(historyIndex, 1);
        }
        windowHistory.push(targetId);
        currentWindow = targetId;
      }

      dockNavItems.forEach((item) => {
        const itemWindow = item.getAttribute("data-window");
        if (itemWindow === targetId) {
          activeClasses.forEach((cls) => item.classList.add(cls));
        } else {
          activeClasses.forEach((cls) => item.classList.remove(cls));
        }
      });
    }

    function closeWindow(windowId: string) {
      const windowElement = document.getElementById(windowId);
      if (windowElement) {
        windowElement.classList.remove("active");
        windowElement.classList.add("exit");
        setTimeout(() => {
          windowElement.classList.remove("exit");
        }, 500);
      }

      const historyIndex = windowHistory.indexOf(windowId);
      if (historyIndex !== -1) {
        windowHistory.splice(historyIndex, 1);
      }

      if (windowHistory.length > 0) {
        const previousWindow = windowHistory[windowHistory.length - 1];
        currentWindow = previousWindow;
        const prevElement = document.getElementById(previousWindow);
        if (prevElement) {
          setTimeout(() => {
            prevElement.classList.remove("exit");
            prevElement.classList.add("active");
          }, 200);
        }
        updateDockActiveState();
      } else {
        currentWindow = null;
        updateDockActiveState();
        showCat();
      }
    }

    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const windowId = btn.getAttribute("data-close-window");
        if (windowId) {
          closeWindow(windowId);
        }
      });
    });

    dockNavItems.forEach((item) => {
      item.addEventListener("click", () => {
        const targetWindow = item.getAttribute("data-window");
        if (targetWindow) {
          switchWindow(targetWindow);
        }
      });
    });

    document.addEventListener("keydown", (e) => {
      if (
        e.target instanceof HTMLInputElement ||
        e.target instanceof HTMLTextAreaElement
      ) {
        return;
      }

      const targetWindow = windowKeys[e.key];
      if (targetWindow) {
        switchWindow(targetWindow);
      }
    });

    dockItems.forEach((item) => {
      item.addEventListener("mouseenter", () => {
        const itemElement = item as HTMLElement;
        itemElement.style.transform = "scale(1.15) translateY(-2px)";
      });

      item.addEventListener("mouseleave", () => {
        const itemElement = item as HTMLElement;
        itemElement.style.transform = "";
      });
    });

    const dockThemeMode = document.getElementById("dockThemeMode");
    const dockThemeModeText = document.getElementById("dockThemeModeText");
    const dockThemeIconLight = document.getElementById("dockThemeIconLight");
    const dockThemeIconDark = document.getElementById("dockThemeIconDark");
    const dockLangMode = document.getElementById("dockLangMode");
    const dockLangModeText = document.getElementById("dockLangModeText");
    const dockSkillsText = document.getElementById("dockSkillsText");
    const dockProjectsText = document.getElementById("dockProjectsText");
    const html = document.documentElement;

    const dockTranslations = {
      en: {
        skills: "skills",
        projects: "projects",
        dark: "dark",
        light: "light",
      },
      es: {
        skills: "habilidades",
        projects: "proyectos",
        dark: "oscuro",
        light: "claro",
      },
    };

    function syncDockTheme() {
      const isDark = html.classList.contains("dark");
      const lang = (localStorage.getItem("portfolioLang") || "en") as
        | "en"
        | "es";
      const t = dockTranslations[lang];
      if (dockThemeModeText) {
        dockThemeModeText.innerText = isDark ? t.light : t.dark;
      }
      if (dockThemeIconLight && dockThemeIconDark) {
        if (isDark) {
          dockThemeIconLight.classList.remove("hidden");
          dockThemeIconDark.classList.add("hidden");
        } else {
          dockThemeIconLight.classList.add("hidden");
          dockThemeIconDark.classList.remove("hidden");
        }
      }
    }

    function syncDockLang() {
      const lang = (localStorage.getItem("portfolioLang") || "en") as
        | "en"
        | "es";
      const t = dockTranslations[lang];
      if (dockLangModeText) {
        dockLangModeText.innerText = lang === "en" ? "es" : "en";
      }
      if (dockSkillsText) {
        dockSkillsText.innerText = t.skills;
      }
      if (dockProjectsText) {
        dockProjectsText.innerText = t.projects;
      }
      syncDockTheme();
    }

    syncDockTheme();
    syncDockLang();

    const observer = new MutationObserver(() => {
      syncDockTheme();
    });
    observer.observe(html, { attributes: true, attributeFilter: ["class"] });

    window.addEventListener("storage", syncDockLang);

    if (dockThemeMode) {
      dockThemeMode.addEventListener("click", () => {
        const mainThemeBtn = document.getElementById("themeMode");
        if (mainThemeBtn) mainThemeBtn.click();
      });
    }

    if (dockLangMode) {
      dockLangMode.addEventListener("click", () => {
        const mainLangBtn = document.getElementById("langMode");
        if (mainLangBtn) mainLangBtn.click();
        setTimeout(syncDockLang, 50);
      });
    }
  });
</script>
